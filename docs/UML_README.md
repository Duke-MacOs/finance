# UML时序图文档

本目录包含财务系统的UML时序图，详细描述了系统的业务流程和技术架构。

## 📋 时序图列表

### 1. 主业务流程时序图
**文件**: `sequence_diagram.puml`
**描述**: 完整的财务系统业务流程，包含步骤1-4的全流程交互

**主要内容**:
- 步骤1: 合同信息输入和摊销计算
- 步骤2: 保存合同和摊销台账（只支持修改，不支持增删行）
- 步骤3: 会计分录预览
- 步骤4: 付款执行阶段
- 查询和管理功能

### 2. 付款阶段详细时序图
**文件**: `payment_sequence_diagram.puml`
**描述**: 专门针对步骤4付款阶段的详细业务逻辑

**主要内容**:
- 付款预览阶段（各种付款情形）
- 付款执行阶段（数据持久化）
- 付款查询和管理
- 付款取消功能

### 3. 系统架构交互时序图
**文件**: `system_architecture_sequence.puml`
**描述**: 展示系统各层次组件之间的交互关系

**主要内容**:
- 前端层 → 控制器层 → 服务层 → 仓储层 → 数据层
- 分层架构的职责分离
- 依赖注入和调用关系

### 4. 数据流转时序图
**文件**: `data_flow_sequence.puml`
**描述**: 数据实体在系统中的创建、转换和流转过程

**主要内容**:
- DTO与实体的转换
- 数据持久化流程
- 审计字段管理
- 外键关系维护

## 🔧 查看方法

### 方法1: 使用PlantUML插件（推荐）

#### VS Code
1. 安装 `PlantUML` 插件
2. 打开 `.puml` 文件
3. 按 `Alt + D` 预览图形

#### IntelliJ IDEA
1. 安装 `PlantUML integration` 插件
2. 打开 `.puml` 文件
3. 右键选择 "Show PlantUML Diagram"

### 方法2: 在线查看
1. 访问 [PlantUML Online Server](http://www.plantuml.com/plantuml/uml/)
2. 复制 `.puml` 文件内容
3. 粘贴到在线编辑器查看

### 方法3: 本地PlantUML
```bash
# 安装PlantUML
brew install plantuml  # macOS
# 或
sudo apt-get install plantuml  # Ubuntu

# 生成PNG图片
plantuml sequence_diagram.puml
plantuml payment_sequence_diagram.puml
plantuml system_architecture_sequence.puml
plantuml data_flow_sequence.puml
```

## 📊 业务流程说明

### 核心业务流程
```
用户输入 → 摊销计算 → 保存台账 → 会计分录 → 付款执行
   ↓           ↓           ↓           ↓           ↓
 步骤1       步骤1       步骤2       步骤3       步骤4
```

### 付款业务逻辑
```
付款金额 vs 选择期间总额
    ├── 平账: 金额相等
    ├── 多付: 付款 > 期间总额
    │   ├── 小额差异 → 费用科目
    │   └── 大额差异 → 预付科目
    └── 少付: 付款 < 期间总额
        ├── 小额差异 → 贷记费用
        └── 大额差异 → 贷记预付
```

### 系统架构层次
```
前端层 (Frontend)
    ↓
控制器层 (Controllers)
    ↓
服务层 (Services)
    ↓
仓储层 (Repositories)
    ↓
数据层 (Database)
```

## 🎯 关键设计模式

### 1. MVC架构模式
- **Controller**: 处理HTTP请求，参数验证
- **Service**: 业务逻辑处理，事务管理
- **Repository**: 数据访问抽象

### 2. DTO模式
- **Request DTO**: 接收前端请求数据
- **Response DTO**: 返回给前端的数据
- **Entity**: 数据库实体映射

### 3. 策略模式
- 摊销计算的三种场景策略
- 付款情形的处理策略

## 📝 时序图符号说明

| 符号 | 含义 |
|------|------|
| `->` | 同步调用 |
| `-->` | 返回响应 |
| `activate/deactivate` | 对象生命周期 |
| `alt/else/end` | 条件分支 |
| `note` | 注释说明 |
| `box` | 分组框 |

## 🔍 业务场景映射

### 需求文档场景对应
- **场景1**: 当前时间 < 合同开始时间 → 平均摊销
- **场景2**: 合同期间内 → 未开始期间记当前月
- **场景3**: 当前时间 > 合同结束时间 → 记当前月

### 付款情形对应
- **情形1**: 不涉及预提待摊 → 直接费用分录
- **情形2.1-2.6**: 涉及预提待摊 → 复杂分录逻辑

## 💡 使用建议

1. **开发阶段**: 参考系统架构图理解代码结构
2. **测试阶段**: 参考业务流程图设计测试用例
3. **部署阶段**: 参考数据流图理解数据依赖
4. **维护阶段**: 参考付款详细图排查业务问题

---

这些时序图完整描述了财务系统的设计思路和实现逻辑，是理解和维护系统的重要参考文档。
